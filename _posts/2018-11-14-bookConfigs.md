---
layout: post
title:  "爱阅书香之自定义书源帮助文档"
author: Terry
date:   2018-11-14 17:17:00 +0800
categories: 爱阅书香
hide: false
tags: 书源配置 爱阅书香 自定义来源
---
 
* content
{:toc}

# 自定义书源说明

书源配置功能，是指从给定的网站来，将其数据按一定的规则，映射到软件中。爱阅书香提供了一系统的规则，以便您使用。

爱阅书香的所有数据接口，都是可配置的。支持非常丰富的自定义数据，包含以下
1. **书籍搜索**
2. **列表详情**：这是一个根据给定的地址，主要为了解析出书籍的**章节标题**和**章节地址**。默认处理方式为[动态解析](/2018/02/23/sourceConfigs/)。
3. **章节详情**：解析出指定章节的内容。默认处理方式为[动态解析](/2018/02/23/sourceConfigs/)。
4. **书海配置**：根据给定的规则，最终生成一组书籍信息。类似榜单，分类，书单都可以在这里完成
5. **书籍详情**：解析出书籍的详细信息，包含简介，封面，字数等，具体可参考配置界面的**添加**
6. **多来源搜索**：解析出多个来源，一般不需要用到。只有聚合类网站才会需要到。
7. **关键词联想**：当你在搜索界面，输入时进行的联想的配置，解析出一系列的联想词。


想自行配置书源，您需要学会简单的数据分析，解析方式支持XPath，JSON，正则表达式。






# 书源配置的结构定义

分为**书籍详情**，**来源详情** 和 **章节详情**

1. 书籍详情：一本书的信息，包含字数，简介，封面，状态，留存率，更新时间等
2. 来源详情：具体提供数据的来源，包含名称（某一个网站只有一个来源，则默认就是配置名），目录地址，更新时间等
3. 章节详情：具体的章节信息，包含内容（正文），标题，地址等

爱阅书香提供的大部分配置，都是为了充填这三个结构的数据而做的。


## 一个简单的例子

请参考默认提供的书源配置中，被禁用掉的“U小说”与“E小说”。这两个配置只写了**书籍搜索**的规则。章节列表与详情方面的内容，则是使用默认的[动态解析](/2018/02/23/sourceConfigs/)来处理。大部情况，你自行添加的源，都只需要书写这一规则。

下面是E小说的配置，若你没有此配置，可以**复制以下代码**，然后在配置中选择菜单**导入剪切板中的书源信息**
```shell
{
    "enable":1,
    "weight":9,
    "priorityEncoding":4,
    "responseType":0,
    "name":"E小说",
    "bookWorld":{},
    "lastModifyTime":"2018-11-14 23:21:35",
    "homeUrl":"https://www.zwda.com/",
    "authorId":"6d2370e2088b9556423c257fd3f8c5dd",
    "httpConfigs":{
        "useCookies":1,
        "headers":{}
    },
    "searchBook":{
        "forGetMethod":1,
        "nextPageForGetMedthod":1,
        "maxPageCount":"3",
        "nextPageParams":{},
        "params":{},
        "url":"https://www.zwda.com/search.php?keyword=%@",
        "nextPageUrl":"//div[@class=\"search-result-page-main\"]/a[@title='下一页']/@href",
        "parser":{
            "bookName":".//h3//span/text()",
            "_1":{
                "dirURL":".//h3/a/@href"
            },
            "desc":".//p[@class=\"result-game-item-desc\"]",
            "_list":"//div[@class=\"result-item result-game-item\"]",
            "coverUrl":".//div[@class=\"result-game-item-pic\"]//img/@src",
            "lastUpdateDate":".//p[@class=\"result-game-item-info-tag\"][3]/span[2]/text()",
            "typeText":".//p[@class=\"result-game-item-info-tag\"][2]/span[2]/text()",
            "author":".//p[@class=\"result-game-item-info-tag\"][1]/span[2]//text()"
        }
    }
}
```

### 规则之访问地址生成

不管我们在搜索信息，或者是访问内容，都需要一个地址（URL）。

**搜索书籍**配置中，使用的URL如下：

```
"url":"https://www.zwda.com/search.php?keyword=%@"
```

其中**%@**是一个可用于替换关键词的标志。更复杂的生成URL方式，在后续再进行说明

### 规则之使用xPath解析数据

xPath是一种HTML解析技术，相对于正则来说，它比较简单，掌握一下语法就能快速的写出解析规则了。

我们使用生成后的URL去访问，返回一般是一个HTML的内容。这时就需要使用xPath来进行解析了。

HTML的内容一般如下
```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>标题信息</title>
    .....
</head>
<body>
.....
....
<div class="result-list">
    <div class="result-item">
        <a href="http://icc.one/1" ...>
        <img src="....">
        .....
    </div>
    <div class="result-item">
        <a href="http://icc.one/2" ...>
        <img src="....">
        .....
    </div>
</div>
....
...
</body>
</html>
```

xpath的简单使用
```shell
#获取标题的信息
//title/text()

#获取class 为 result-item 的元素
//div[@class="result-item"]
```

切记：不同网站的网站是不一样的，那解析方式也就不一样了

xPath的语法请自行百度后尝试，本文最下面有附录可参考下基本语法。

一般也就是 **//xxx[@id='yy']** 之类的进行定义就可以。

### 爱阅支持的正则表达式
正则表达式除了标准的正则，还支持自定义的方式

例子
```
#表示将匹配**<p>**与**</p>**之间的内容
<p>.*?</p>

```

自定义的正则处理格式：
```
reg1 @[1,3] reg2 @ ... regn @[x...yz]=>newString
```

支持只有 reg1, 若有多个reg时，' @' 是不可省的，@之后可以接 [] 或 => 或 空格
 
当存在 => 标志时，表示所有匹配到的数据，都将替换成新字符串；否则表示将所有匹配到的数据合并成新的内容

=> 标志必须在最后才能出现
[] 范围指定,如1, !3 之类的序号,空表示全匹配，!n表示除了n之外的其它序号都有效
当错误时，返回nil

例子
```
# 第一个<p>..</p>的信息替换为XYZ
<p>.*?</p> @[0]=>XYZ    

#获取第二个<p>..</p>与<ul>...</ul>的所有内容
<p>.*</p> @[1] <ul>.*</ul>  
```


## 在爱阅书香的使用

爱阅书香提供了书源配置的界面，在你写配置时，最好是提供界面提供的功能来写规则

要获取数据，那需要去服务器请求，请求之后就是响应。所以爱阅提供了**请求配置**与**响应配置**。

![搜索配置界面](/files/bcs.png)

### 请求配置
其中，请求配置中，可以设置一个**请求的地址**，**参数**，**方法**。还可以设置如何访问**下一页**

之后，你可以点击**测试请求**进行请求数据的界面，若配置无误，此时可查看以下内容
1. 查看原始内容：这是服务器返回的原始数据
2. 查看分析结果：这是根据你写的规则，解析出来的数据。若没有规则，则为空。
3. 查看HTTP协议：这是根据你的请求配置生成的HTTP请求，可以看你生成的URL，参数是否正确

另外，若你成功配置了如何访问**下一页**的规则，则界面的最下面还有**当前第X页，点击访问下一页**的功能，这个也是在搜索时可翻页的关键，此时请记得设置**最大请求页数**

注意：

* 若你要进行配置时，一定要在配置好**请求配置**后，点击进入**测试请求**界面，以后后续进行**测试响应**。

当你修改了配置后，可**重新请求**来看生成的最终数据是否符合要求。

* 若请求返回的是一个HTML，则默认的响应解析规则是使用xPath。你可以使用**@regex:**的前缀来使用正则进行解析；
* 若请求返回的是一个JSON，默认是很使用JSON来解析，你同样可以强制使用**@xpath:**的前缀进行解析。


### 响应配置
此配置是为了将获取到的原始数据解析为爱阅书香可理解的数据结构。当原始数据为：
1. HTML或XML时，可使用xPath进行解析。
2. JSON时，可使用 attr1.attr2.attr3 的方式解析指定数据
3. 直接当成文本处理，可使用正则表示式（@regex:）的解析数据，如: <p>.*?</p> @[0]=>XYZ 将匹配到<p>与</p>之类的内容的第一个替换为XYZ

爱阅书香支持以下的解析规则前缀
* **@def:**：直接定义
* **@xpath:**：使用xPath进行解析
* **@json:**：使用JSON解析，如a.b.c之类的
* **@regex:**：使用正则解析，支持后面说的自定义正则

这几种解析方式可以混合进行的，比如先使用**@xpath:**之后，再使用**@regex:**

#### 响应配置之书籍搜索

一次搜索请求，一般可以解析出多个书籍信息。所以需要写**分割为多个书籍信息**的规则，此规则将把内容分割为多个信息，然后再使用**书名**，**作者**等规则，把对应的数据解析出来。

如将**分割为多个书籍信息**设置为

```
//div[@class="result-item result-game-item"]
```

此时可以生成多个**书籍详情**的原数据
再根据**书名**和**作者**就可以解析出每一本书籍的基本信息了
```
.//h3//span/text()
.//p[@class="result-game-item-info-tag"][1]/span[2]//text()
```

PS:每一个网站的解析规则基本都是不一样的，请自行参考xPath的语法。

在写规则时，可打开**测试响应**界面，此界面可拖动，可缩放。当你的规则变化时，可使用**同步**功能后，在**测试响应**界面上作刷新，可反映规则的正确与否。在此界面，解析出的数据是原始数据。爱阅书香还会根据不同的字段做进一步的处理。比如，解析出**章节内容**时，在这里的表示可以就是一段包括HTML的数据，但在最终生成时，会自动删除其中的HTML并自动分段的。可以在**请求测试**中点击**重新请求**来看下最终的生成数据。

解析规则可参考前面的例子。

##### 一个搜索配置的例子

步骤
1. 创建书源，输入名称**测试书源**与主页**https://www.22ff.org/**
2. 点击**书籍搜索**，输入地址**https://www.22ff.org/s_%@**
3. 点击**请求测试**
4. 在**响应配置**的**分割为多个书籍信息**中输入：**//ul**
5. **书名**中输入：**.//li[@class="neirong1"]/a[1]/text()**
6. **作者**中输入：**.//li[@class="neirong4"]/a[1]/text()**
7. 点击**来源解析器**，添加字段**章节目录地址**，输入：.//li[@class="neirong1"]/a[1]/@href
8. 重新进入**请求测试**界面，点击**重新请求**
9. 点击**查看分析结果**，对比下数据是否正确，若正确，则已经完成

这个简单的书源就算是配置成功了。你可以禁用其它的所有书源，只启用此配置，再使用爱阅的搜索界面去搜索书籍。看下是否正确

注意：
要成功生成一个书籍详情，必须存在**书名**与**作者**。

# 附录

1. [xPath的基本语法](http://www.runoob.com/xpath/xpath-syntax.html)
2. [正则表达式简单语法](http://www.runoob.com/regexp/regexp-syntax.html)
