---
layout: post
title:  "爱阅书香之自定义书源帮助文档"
author: Terry
date:   2018-11-14 17:17:00 +0800
categories: 爱阅书香
hide: false
tags: 书源配置 爱阅书香 自定义来源
---
 
* content
{:toc}

# 在阅读本文之前
因版权关系，爱阅书香将从6.1.0版本之后，不再提供默认的书源配置。请自行根据以下规则，配置自己的书源

# 看看别人写的书源
这里有一些**其他同学** 写好的 [更多书源信息](/2018/11/16/moreBookConfigs/)，你可以[点击](/2018/11/16/moreBookConfigs/)进去看看,之后***根据说明进行导入***就**可以**了。


书源并非越多越好，满足你的需求就够了。
除了自定义书源之后，你还可以使用[自定义来源](/2018/02/23/sourceConfigs/)

先说明下所谓的**自定义来源**与**自定义书源**的区别，前者只是针对一个url。后者针对的是整个应用的配置。
* **来源**：自动把你提供的url解析成一组章节信息，再从解析出来的章节信息中解析出对应的内容。基本无须你做什么工作。
* **书源**：需要指定各种配置的请求信息与响应信息。可配置整个软件的所有数据接口。







# 一个最简单的书源

步骤
1. 创建书源，输入名称**测试书源**与主页**https://www.22ff.org/**
2. 点击**书籍搜索**，输入地址**https://www.22ff.org/s_%@**
3. 点击**请求测试**
4. 在**响应配置**的**分割为多个书籍信息**中输入：**//ul**
5. **书名**中输入：**.//li[@class="neirong1"]/a[1]/text()**
6. **作者**中输入：**.//li[@class="neirong4"]/a[1]/text()**
7. 点击**来源解析器**，添加字段**章节目录地址**，输入：.//li[@class="neirong1"]/a[1]/@href
8. 重新进入**请求测试**界面，点击**重新请求**
9. 点击**查看分析结果**，对比下数据是否正确，若正确，则已经完成

这个简单的书源就算是配置成功了。你可以禁用其它的所有书源，只启用此配置，再使用爱阅的搜索界面去搜索书籍。看下是否正确。

注意：
要成功生成一个书籍详情，必须存在**书名**,**作者**和**章节目录**。



# 自定义书源说明


书源配置功能，是指从给定的网站来，将其数据按一定的规则，映射到软件中。爱阅书香提供了一系统的规则，以便您使用。

爱阅书香的所有数据接口，都是可配置的。支持非常丰富的自定义数据，包含以下
1. **书籍搜索**：搜索出相关内容的一个配置。
2. **列表详情**：这是一个根据给定的地址，主要为了解析出书籍的**章节标题**和**章节地址**。默认处理方式为[动态解析](/2018/02/23/sourceConfigs/)。
3. **章节详情**：解析出指定章节的内容。默认处理方式为[动态解析](/2018/02/23/sourceConfigs/)。
4. **书海配置**：根据给定的规则，最终生成一组书籍信息。类似榜单，分类，书单都可以在这里完成
5. **书籍详情**：解析出书籍的详细信息，包含简介，封面，字数等，具体可参考配置界面的**添加**
6. **多来源搜索**：解析出多个来源，一般不需要用到。只有聚合类网站才会需要到。
7. **关键词联想**：当你在搜索界面，输入时进行的联想的配置，解析出一系列的联想词。


# 书源配置的结构定义

分为**书籍详情**，**来源详情** 和 **章节详情**

1. 书籍详情：一本书的信息，包含字数，简介，封面，状态，留存率，更新时间等
2. 来源详情：具体提供数据的来源，包含名称（某一个网站只有一个来源，则默认就是配置名），目录地址，更新时间等
3. 章节详情：具体的章节信息，包含内容（正文），标题，地址等

爱阅书香提供的大部分配置，都是为了充填这三个结构的数据而做的。


## 一个简单的例子

请参考默认提供的书源配置中，被禁用掉的“U小说”与“E小说”。这两个配置只写了**书籍搜索**的规则。章节列表与详情方面的内容，则是使用默认的[动态解析](/2018/02/23/sourceConfigs/)来处理。大部情况，你自行添加的源，都只需要书写这一规则。

下面是E小说的配置，若你没有此配置，可以**复制以下代码**，然后在配置中选择菜单**导入剪切板中的书源信息**
```shell
{
    "enable":1,
    "weight":9,
    "priorityEncoding":4,
    "responseType":0,
    "name":"E小说",
    "bookWorld":{},
    "lastModifyTime":"2018-11-14 23:21:35",
    "homeUrl":"https://www.zwda.com/",
    "authorId":"",
    "httpConfigs":{
        "useCookies":1,
        "headers":{}
    },
    "searchBook":{
        "forGetMethod":1,
        "nextPageForGetMedthod":1,
        "maxPageCount":"3",
        "nextPageParams":{},
        "params":{},
        "url":"https://www.zwda.com/search.php?keyword=%@",
        "nextPageUrl":"//div[@class=\"search-result-page-main\"]/a[@title='下一页']/@href",
        "parser":{
            "bookName":".//h3//span/text()",
            "_1":{
                "dirURL":".//h3/a/@href"
            },
            "desc":".//p[@class=\"result-game-item-desc\"]",
            "_list":"//div[@class=\"result-item result-game-item\"]",
            "coverUrl":".//div[@class=\"result-game-item-pic\"]//img/@src",
            "lastUpdateDate":".//p[@class=\"result-game-item-info-tag\"][3]/span[2]/text()",
            "typeText":".//p[@class=\"result-game-item-info-tag\"][2]/span[2]/text()",
            "author":".//p[@class=\"result-game-item-info-tag\"][1]/span[2]//text()"
        }
    }
}
```

### 规则之使用xPath解析数据

xPath是一种HTML解析技术，相对于正则来说，它比较简单，掌握一下语法就能快速的写出解析规则了。

我们使用生成后的URL去访问，返回一般是一个HTML的内容。这时就需要使用xPath来进行解析了。

HTML的内容一般如下
```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>标题信息</title>
    .....
</head>
<body>
.....
....
<div class="result-list">
    <div class="result-item">
        <a href="http://icc.one/1" ...>
        <img src="....">
        .....
    </div>
    <div class="result-item">
        <a href="http://icc.one/2" ...>
        <img src="....">
        .....
    </div>
</div>
....
...
</body>
</html>
```

以下是xpath的简单使用
```shell
#获取标题的信息
//title/text()

#获取class 为 result-item 的元素
//div[@class="result-item"]
```

切记：不同网站的网站是不一样的，那解析方式也就不一样了

xPath的语法请自行百度后尝试，本文最下面有附录可参考下基本语法。

一般也就是 **//xxx[@id='yy']** 之类的进行定义就可以。

在书源配置中，可使用**@xpath:**作为前缀来表示使用xPath来解析。

### 规则之JSON解析

支持以：**attr1.attr2.attr3[2].obj** 的方式解析出对应的数据。若属性是数据，使用**-1**, **-2**之类的，表示从后向前。

若不明什么是JSON数据，请自行百度。

### 规则之正则表达式
支持正则表达式组合处理。假设有一段内容为c, 有正则表示达r1, r2, ...rn等

要取正则r1的第一个匹配内容
```shell
r1 @[0]
```

替换所有匹配到的内容为xxx
```shell
r1 @=>xxx
```

只替换匹配到的内容的第4个内容为空
```shell
r1 @[3]=> 
```

除了第1个配置的内容，其它配置的内容全部替换为新内容：XYZ
```shell
r1 @[!0]=>XYZ
```

完整的格式：
```
reg1 @[1,3] reg2 @ ... regn @[x...yz]=>newString
```

支持只有 reg1, 若有多个reg时，** @** 是不可省的(注意@前面的空格是必须存在的)，@之后可以接**[]**或**=>**或**空格**
 
当存在 **=>** 标志时，表示所有匹配到的数据，都将替换成新字符串；否则表示将所有匹配到的数据合并成新的内容

* **=>**：标志必须在最后才能出现，在**=>**之后，为替换后的内容，包含前后空格
* **[]**：范围指定,如1, !3 之类的序号,空表示全匹配，!n表示除了n之外的其它序号都有效
当错误时，返回空。

例子
```
# 第一个<p>..</p>的信息替换为XYZ
<p>.*?</p> @[0]=>XYZ    

#获取第二个<p>..</p>与<ul>...</ul>的所有内容
<p>.*</p> @[1] <ul>.*</ul>  

#将主角名：陈大龙 修改为 爱阅书香
陈大龙 @=>爱阅书香
```

注意：此规则的同样应用于[内容过滤器](/2018/11/29/contentFilters/)功能

### 规则之定义
有些字段的内容，是需要通过自行定义了，这时就需要使用**@def:**了。如在书海配置中，要定义某一数据只在**男生频道**中使用，就可以使用了。

# 搜索配置
此配置就是提供搜索功能的配置。包含**关键词**，**指定URL**，**请求测试**，**响应解析**。

![搜索配置界面](/files/bcs.png)

## 关键词
请求的关键词默认编码为UTF8，更多编码，可通过**配置首页**的高级功能进行设置。


在高级配置中的**请求时参数值处理**，输入以下代码
若是GB2312，可使用以下方式做修改
```
# 格式为GB2313
JxdSecuritySub.Gb2312Encoded:value

# 格式为BASE64
JxdSecuritySub.Base64EncodeByString:value

```

## 指定URL

这个必须由你指定，使用**%@**来表示关键词。若要搜索更多的页数，可在**更多请求配置**中设置

如设置搜索地址为
```
"url":"http://icc.one/search.php?keyword=%@"
```

## 请求测试

在你完成以上内容之后，可以点击**测试请求**进行请求数据的界面，若配置无误，此时可查看以下内容

1. 查看原始内容：这是服务器返回的原始数据
2. 查看分析结果：这是根据你写的规则，解析出来的数据。若没有规则，则为空。
3. 查看HTTP协议：这是根据你的请求配置生成的HTTP请求，可以看你生成的URL，参数是否正确

另外，若你成功配置了如何访问**下一页**的规则，则界面的最下面还有**当前第X页，点击访问下一页**的功能，这个也是在搜索时可翻页的关键，此时请记得设置**最大请求页数**

注意：

* 若你要进行配置时，一定要在配置好**请求配置**后，点击进入**测试请求**界面，以后后续进行**测试响应**。

当你修改了配置后，可**重新请求**来看生成的最终数据是否符合要求。

* 若请求返回的是一个HTML，则默认的响应解析规则是使用xPath。你可以使用**@regex:**的前缀来使用正则进行解析；
* 若请求返回的是一个JSON，默认是很使用JSON来解析，你同样可以强制使用**@xpath:**的前缀进行解析。
* 只有**查看分析结果**的有正确的内容，爱阅书香才能正常处理。


## 响应解析
这个是最重要的，只有你配置好响应解析之后，才能为爱阅书香所用。

一般情况，至少需要写的规则有：
* 分割为多个书籍信息，若每次搜索都只有一本，可不填
* 书名
* 作者名
* 来源解析器 -> 章节目录地址，这个地址默认在**列表详情**配置中使用。

当使用**分割**规则时，则后续的**书名**等等的规则要处理的内容，都只是分割后数据的一部分。

如我们有以下数据
```

a,b,c,d,e,f

```
使用**分割**功能，按**，**进行分割后，将生成数组【a,b,c,d,e,f】，数组的每个元素，都将执行**书名**，**作者名**等规则。

若是没有使用**分割**功能，则将整个内容，执行**书名**等规则。


解析规则相关：
1. HTML或XML时，可使用xPath进行解析。
2. JSON时，可使用 attr1.attr2.attr3 的方式解析指定数据
3. 直接当成文本处理，可使用正则表示式（@regex:）的解析数据，如: <p>.*?</p> @[0]=>XYZ 将匹配到<p>与</p>之类的内容的第一个替换为XYZ


爱阅书香支持以下的解析规则前缀
* **@def:**：直接定义
* **@xpath:**：使用xPath进行解析
* **@json:**：使用JSON解析，如a.b.c之类的
* **@regex:**：使用正则解析，支持后面说的自定义正则

这几种解析方式可以混合进行的，比如先使用**@xpath:**之后，再使用**@regex:**

在默认的情况下，当响应是一个HTML，若是使用xpath进行解析时，不需要写@xpath:的前缀。若为JSON，则无需写@json:。其它情况类同。

一次搜索请求，一般可以解析出多个书籍信息。所以需要写**分割为多个书籍信息**的规则，此规则将把内容分割为多个信息，然后再使用**书名**，**作者**等规则，把对应的数据解析出来。

如将**分割为多个书籍信息**设置为

```
//div[@class="result-item result-game-item"]
```

此时可以生成多个**书籍详情**的原数据
再根据**书名**和**作者**就可以解析出每一本书籍的基本信息了
```
.//h3//span/text()
.//p[@class="result-game-item-info-tag"][1]/span[2]//text()
```

PS:每一个网站的解析规则基本都是不一样的，请自行参考xPath的语法。

在写规则时，可打开**测试响应**界面，此界面可拖动，可缩放。当你的规则变化时，可使用**同步**功能后，在**测试响应**界面上作刷新，可反映规则的正确与否。在此界面，解析出的数据是原始数据。爱阅书香还会根据不同的字段做进一步的处理。比如，解析出**章节内容**时，在这里的表示可以就是一段包括HTML的数据，但在最终生成时，会自动删除其中的HTML并自动分段的。可以在**请求测试**中点击**重新请求**来看下最终的生成数据。

### 一个搜索配置的例子

步骤
1. 创建书源，输入名称**测试书源**与主页**https://www.22ff.org/**
2. 点击**书籍搜索**，输入地址**https://www.22ff.org/s_%@**
3. 点击**请求测试**
4. 在**响应配置**的**分割为多个书籍信息**中输入：**//ul**
5. **书名**中输入：**.//li[@class="neirong1"]/a[1]/text()**
6. **作者**中输入：**.//li[@class="neirong4"]/a[1]/text()**
7. 点击**来源解析器**，添加字段**章节目录地址**，输入：.//li[@class="neirong1"]/a[1]/@href
8. 重新进入**请求测试**界面，点击**重新请求**
9. 点击**查看分析结果**，对比下数据是否正确，若正确，则已经完成

这个简单的书源就算是配置成功了。你可以禁用其它的所有书源，只启用此配置，再使用爱阅的搜索界面去搜索书籍。看下是否正确

注意：
要成功生成一个书籍详情，必须存在**书名**与**作者**。

### 更多响应配置
* 优先编码方式：若出现原始数据全为乱码时，可通过改动此值要修改。一般都是**Utf8** 或是 **GB2312** 之类的
* 响应数据处理方式：若出现规则写得对，但无法解析出来，可尝试修改此值。

# 列表详情
在更新指定来源的章节列表时被使用，目的是把每一个章节的标题与对应的地址解析出来。

当来源地址有效时，若你不进行配置，默认是使用动态解析的方式自动解析出来的。

否则，你必须写规则来解析。

此配置的规则与搜索类同，不再复述。

# 章节详情
获取章节的内容，默认使用动态解析

# 书海无涯
这个也许比较中二的名字，是突发奇想的。这个功能主要是想把所有你喜欢的数据汇合在一起，通过一系列的处理，生成一组书籍的信息。方便你慢慢的查阅，而不是通过搜索的方式而来。

这块的配置比其它的要复杂那么一点点。以下分别进行说明

## 配置应用类型
支持类型：
* 书海无涯：这个就是主界面菜单上的**书海无涯**，显示在界面的
* 热词：主要是获取一组热门的书籍名称，应用在搜索界面上的**热词**
* 应用所有：同时支持以上两者

## 分类地址配置
支持：
* 动态地址：给定一个地址，从这个地址的响应内容解析出生成一组地址信息。
* 固定地址：直接添加一组地址就可以。

## 请求配置
从分类地址配置中，分成了一组地址信息，请求配置，可对这些地址做些处理之后，得到的地址再去请求数据。

## 响应配置
这块的规则与**书籍搜索**配置基本一样，一般可以从书籍搜索配置中复制到此，再进行必须的修改就可以了。

# 附录

1. [xPath的基本语法](http://www.runoob.com/xpath/xpath-syntax.html)
2. [正则表达式简单语法](http://www.runoob.com/regexp/regexp-syntax.html)
